#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
TruthGuardian 2.0 - Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ­Ù…Ø§ÙŠØ© Ù…ØªÙ‚Ø¯Ù… Ù„Ù€ Termux
"""

import os
import sys
import time
import logging
import hashlib
import json
import yaml
import threading
from datetime import datetime
import telegram
from dotenv import load_dotenv

# Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
logging.basicConfig(
    level=logging.INFO,
    format="[%(asctime)s][%(levelname)s] %(message)s",
    handlers=[logging.StreamHandler(sys.stdout)]
)
log = logging.getLogger()

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
tg_bot = telegram.Bot(token=TELEGRAM_TOKEN) if TELEGRAM_TOKEN else None

# ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªÙƒÙˆÙŠÙ†
CONFIG_PATH = os.path.join(os.environ["HOME"], "truthguardian_config.yaml")
DEFAULT_CONFIG = {
    "monitored_files": [
        "/etc/passwd",
        "/etc/hosts",
        f"{os.environ['HOME']}/.bashrc"
    ],
    "scan_interval": 30,
    "log_interval": 300,
    "suspicious_patterns": ["password", "secret", "key", "token", "auth"]
}

def load_config():
    try:
        if os.path.exists(CONFIG_PATH):
            with open(CONFIG_PATH, 'r') as f:
                return yaml.safe_load(f)
        else:
            with open(CONFIG_PATH, 'w') as f:
                yaml.safe_dump(DEFAULT_CONFIG, f)
            return DEFAULT_CONFIG
    except Exception as e:
        log.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒÙˆÙŠÙ†: {e}")
        return DEFAULT_CONFIG

# ===============================
# Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
# ===============================
class SystemMonitor:
    def __init__(self):
        self.metrics = {}

    def get_cpu_usage(self):
        def get_cpu_stats():
            try:
                with open('/proc/stat') as f:
                    line = f.readline()
                if line.startswith('cpu '):
                    parts = line.split()
                    return sum(int(p) for p in parts[1:]), int(parts[4])
            except:
                return 0, 0

        total1, idle1 = get_cpu_stats()
        time.sleep(1.0)  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¯Ù‚Ø©
        total2, idle2 = get_cpu_stats()
        total_diff = total2 - total1
        idle_diff = idle2 - idle1
        return 100 * (total_diff - idle_diff) / total_diff if total_diff > 0 else 0

    def get_memory_usage(self):
        try:
            with open('/proc/meminfo') as f:
                lines = f.readlines()
            mem_info = {line.split()[0].rstrip(':'): int(line.split()[1]) for line in lines if len(line.split()) >= 2}
            total = mem_info.get('MemTotal', 0)
            available = mem_info.get('MemAvailable', 0)
            return 100 * (total - available) / total if total > 0 else 0
        except:
            return 0

    def get_network_usage(self):
        try:
            with open('/proc/net/dev') as f:
                lines = f.readlines()
            for line in lines:
                if 'wlan0' in line:  # Ø§ÙØªØ±Ø§Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
                    parts = line.split()
                    return int(parts[1]), int(parts[9])  # bytes received, sent
            return 0, 0
        except:
            return 0, 0

    def collect_metrics(self):
        rx1, tx1 = self.get_network_usage()
        time.sleep(1.0)
        rx2, tx2 = self.get_network_usage()
        self.metrics = {
            'timestamp': datetime.now().isoformat(),
            'cpu_usage': round(self.get_cpu_usage(), 2),
            'memory_usage': round(self.get_memory_usage(), 2),
            'network_rx': round((rx2 - rx1) / 1024, 2),  # KB/s
            'network_tx': round((tx2 - tx1) / 1024, 2)   # KB/s
        }
        return self.metrics

# ===============================
# Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
# ===============================
class FileIntegrityChecker:
    def __init__(self):
        self.checksums = {}

    def calculate_hash(self, filepath):
        try:
            hasher = hashlib.sha256()
            with open(filepath, 'rb') as f:
                for chunk in iter(lambda: f.read(8192), b""):  # Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©
                    hasher.update(chunk)
            return hasher.hexdigest()
        except Exception as e:
            log.error(f"Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¬Ø²Ø¦Ø© Ù„Ù€ {filepath}: {e}")
            return None

    def monitor_file(self, filepath):
        current_hash = self.calculate_hash(filepath)
        if current_hash is None:
            return False
        if filepath in self.checksums:
            if self.checksums[filepath] != current_hash:
                log.warning(f"âš ï¸ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù„Ù: {filepath}")
                if tg_bot and TELEGRAM_CHAT_ID:
                    tg_bot.send_message(chat_id=TELEGRAM_CHAT_ID, text=f"âš ï¸ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù: {filepath}")
                return False
        else:
            log.info(f"Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ù„Ù: {filepath}")
        self.checksums[filepath] = current_hash
        return True

# ===============================
# Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# ===============================
class TruthGuardian:
    def __init__(self):
        self.config = load_config()
        self.monitor = SystemMonitor()
        self.integrity_checker = FileIntegrityChecker()
        self.running = False
        self.monitored_files = [f for f in self.config['monitored_files'] if os.path.exists(f)]

    def start(self):
        log.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ TruthGuardian 2.0")
        self.running = True
        log.info(f"Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© {len(self.monitored_files)} Ù…Ù„Ù")

        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ Ø®ÙŠØ· Ù…Ù†ÙØµÙ„
        monitor_thread = threading.Thread(target=self.run_monitoring)
        monitor_thread.start()
        monitor_thread.join()

    def run_monitoring(self):
        iteration = 0
        while self.running:
            try:
                iteration += 1
                log.info(f"=== Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© #{iteration} ===")

                # Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                metrics = self.monitor.collect_metrics()
                log.info(f"ğŸ“Š Ø§Ù„Ø£Ø¯Ø§Ø¡: CPU={metrics['cpu_usage']}%, RAM={metrics['memory_usage']}%, "
                        f"RX={metrics['network_rx']} KB/s, TX={metrics['network_tx']} KB/s")

                # Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
                for filepath in self.monitored_files:
                    self.integrity_checker.monitor_file(filepath)

                # Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                if iteration % (self.config['log_interval'] // self.config['scan_interval']) == 0:
                    self.save_logs(metrics)

                time.sleep(self.config['scan_interval'])

            except KeyboardInterrupt:
                log.info("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
                self.stop()
            except Exception as e:
                log.error(f"Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
                time.sleep(60)

    def save_logs(self, metrics):
        try:
            log_dir = os.path.join(os.environ['HOME'], 'truthguardian_logs')
            os.makedirs(log_dir, exist_ok=True)
            log_file = os.path.join(log_dir, f"log_{datetime.now().strftime('%Y%m%d_%H%M')}.json")
            with open(log_file, 'w') as f:
                json.dump({
                    'timestamp': datetime.now().isoformat(),
                    'metrics': metrics,
                    'monitored_files': self.monitored_files,
                    'file_checksums': self.integrity_checker.checksums
                }, f, indent=2)
            log.info(f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ: {log_file}")
        except Exception as e:
            log.error(f"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: {e}")

    def stop(self):
        log.info("ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù TruthGuardian 2.0")
        self.running = False

# ===============================
# Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
# ===============================
def main():
    print("=" * 50)
    print("TruthGuardian 2.0 - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…")
    print("Ù…ØµÙ…Ù… Ø®ØµÙŠØµÙ‹Ø§ Ù„Ù€ Termux")
    print("=" * 50)

    system = TruthGuardian()
    try:
        system.start()
    except Exception as e:
        log.error(f"ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()